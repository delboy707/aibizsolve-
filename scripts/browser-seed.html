<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QEP AISolve - Workflow Seeder</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #1a365d; }
    label { display: block; margin-bottom: 8px; font-weight: 500; }
    input, button {
      padding: 10px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    input { width: 100%; margin-bottom: 16px; }
    button {
      background: #1a365d;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 8px;
    }
    button:hover { background: #2c5282; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    button.danger { background: #c53030; }
    button.danger:hover { background: #9b2c2c; }
    #log {
      background: #1a202c;
      color: #68d391;
      padding: 16px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .status { padding: 12px; border-radius: 6px; margin-bottom: 16px; }
    .status.success { background: #c6f6d5; color: #22543d; }
    .status.error { background: #fed7d7; color: #742a2a; }
    .status.info { background: #bee3f8; color: #2a4365; }
    .progress {
      height: 20px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .progress-bar {
      height: 100%;
      background: #48bb78;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h1>ðŸš€ QEP AISolve Workflow Seeder</h1>

  <div class="card">
    <label>API URL (your deployed app):</label>
    <input type="text" id="apiUrl" value="https://qep-aisolve.vercel.app" placeholder="https://your-app.vercel.app">

    <label>Admin Secret Key:</label>
    <input type="text" id="secretKey" value="qep-seed-2024" placeholder="qep-seed-2024">

    <label>Workflows JSON File:</label>
    <input type="file" id="fileInput" accept=".json">

    <div style="margin-top: 16px;">
      <button onclick="checkStatus()">Check Status</button>
      <button onclick="startSeed()">Start Seeding</button>
      <button onclick="clearWorkflows()" class="danger">Clear All</button>
    </div>
  </div>

  <div class="card">
    <div id="statusBox" class="status info">Ready. Select your workflows-embedded.json file and click "Start Seeding".</div>
    <div class="progress">
      <div id="progressBar" class="progress-bar" style="width: 0%"></div>
    </div>
    <div id="log">Workflow Seeder Log
==================
</div>
  </div>

  <script>
    const BATCH_SIZE = 25; // Smaller batches for reliability
    let workflows = [];

    function log(msg) {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(msg, type = 'info') {
      const statusEl = document.getElementById('statusBox');
      statusEl.textContent = msg;
      statusEl.className = `status ${type}`;
    }

    function setProgress(pct) {
      document.getElementById('progressBar').style.width = `${pct}%`;
    }

    function getApiUrl() {
      return document.getElementById('apiUrl').value.replace(/\/$/, '');
    }

    function getSecretKey() {
      return document.getElementById('secretKey').value;
    }

    async function apiCall(body) {
      const url = `${getApiUrl()}/api/admin/seed-workflows?key=${getSecretKey()}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      return response.json();
    }

    async function checkStatus() {
      log('Checking workflow status...');
      try {
        const result = await apiCall({ action: 'status' });
        log(`Current count: ${result.count}`);
        log(`By domain: ${JSON.stringify(result.byDomain || {})}`);
        setStatus(`Database has ${result.count} workflows`, 'success');
      } catch (err) {
        log(`Error: ${err.message}`);
        setStatus(`Error: ${err.message}`, 'error');
      }
    }

    async function clearWorkflows() {
      if (!confirm('Are you sure you want to delete ALL workflows?')) return;

      log('Clearing all workflows...');
      setStatus('Clearing...', 'info');
      try {
        const result = await apiCall({ action: 'clear' });
        log(result.message || 'Cleared');
        setStatus('All workflows cleared', 'success');
      } catch (err) {
        log(`Error: ${err.message}`);
        setStatus(`Error: ${err.message}`, 'error');
      }
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      log(`Loading file: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
      setStatus('Loading file...', 'info');

      try {
        const text = await file.text();
        workflows = JSON.parse(text);
        log(`Loaded ${workflows.length} workflows`);
        setStatus(`Loaded ${workflows.length} workflows. Ready to seed.`, 'success');
      } catch (err) {
        log(`Failed to parse JSON: ${err.message}`);
        setStatus(`Error parsing file: ${err.message}`, 'error');
      }
    });

    async function startSeed() {
      if (workflows.length === 0) {
        setStatus('Please select a workflows JSON file first', 'error');
        return;
      }

      const totalBatches = Math.ceil(workflows.length / BATCH_SIZE);
      log(`Starting seed: ${workflows.length} workflows in ${totalBatches} batches`);
      setStatus('Seeding in progress...', 'info');

      let inserted = 0;
      let errors = 0;

      for (let i = 0; i < workflows.length; i += BATCH_SIZE) {
        const batch = workflows.slice(i, i + BATCH_SIZE);
        const batchNum = Math.floor(i / BATCH_SIZE) + 1;

        log(`Batch ${batchNum}/${totalBatches} (${batch.length} workflows)...`);
        setProgress((batchNum / totalBatches) * 100);

        try {
          const result = await apiCall({ workflows: batch });
          if (result.success) {
            inserted += result.inserted;
            log(`  âœ“ Inserted ${result.inserted}, total in DB: ${result.totalInDb}`);
          } else {
            errors += batch.length;
            log(`  âœ— Error: ${result.error}`);
          }
        } catch (err) {
          errors += batch.length;
          log(`  âœ— Network error: ${err.message}`);
        }

        // Small delay between batches
        await new Promise(r => setTimeout(r, 100));
      }

      setProgress(100);
      log(`\n========== COMPLETE ==========`);
      log(`Inserted: ${inserted}`);
      log(`Errors: ${errors}`);

      if (errors === 0) {
        setStatus(`Successfully seeded ${inserted} workflows!`, 'success');
      } else {
        setStatus(`Seeded ${inserted} workflows with ${errors} errors`, 'error');
      }

      // Final status check
      await checkStatus();
    }
  </script>
</body>
</html>
